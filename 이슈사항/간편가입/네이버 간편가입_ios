// 1. ë„¤ì´ë²„ ë¡œê·¸ì¸ SDK ì´ˆê¸°í™”
// - SDK ì„¤ì •í•  ë•Œ, **custom redirect URI**ë¥¼ ë“±ë¡

let naverLoginInstance = NaverThirdPartyLoginConnection.getSharedInstance()
naverLoginInstance?.serviceUrlScheme = "myapp" // ì•± ìŠ¤í‚´ ì„¤ì •
naverLoginInstance?.consumerKey = "ë„¤ì´ë²„ Client ID"
naverLoginInstance?.consumerSecret = "ë„¤ì´ë²„ Client Secret"
naverLoginInstance?.appName = "ì•± ì´ë¦„"

// - `serviceUrlScheme`ë¥¼ ì„¤ì •í•˜ë©´, ë„¤ì´ë²„ ì¸ì¦ í›„ `myapp://auth?code=xxx` ì´ëŸ° ì‹ìœ¼ë¡œ ì½œë°±
// ì´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¥¼ ì•±ì´ ê°€ë¡œì±„ê¸°

// 2. AppDelegateì—ì„œ URL ì—´ë¦¼ ì²˜ë¦¬
// `SceneDelegate`ë‚˜ `AppDelegate`ì˜ `open url` ë©”ì„œë“œì—ì„œ ì´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¥¼ ë°›ê¸°

func application(_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey : Any] = [:]) -> Bool {
    
    // ë„¤ì´ë²„ ë¡œê·¸ì¸ SDKê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ë¨¼ì € ë„˜ê²¨ì¤Œ
    if NaverThirdPartyLoginConnection.getSharedInstance()?.application(app, open: url, options: options) == true {
        // ì—¬ê¸°ì„œ Authorization Code ë½‘ì„ ìˆ˜ ìˆìŒ
        if let code = extractAuthorizationCode(from: url) {
            print("Authorization Code:", code)
            
            // ğŸ”¥ ì—¬ê¸°ì„œ codeë¥¼ ë°±ì—”ë“œ ì„œë²„ë¡œ POST í˜¸ì¶œí•´ì„œ ì „ë‹¬
            sendAuthorizationCodeToBackend(code: code)
        }
        return true
    }
    return false
}

// 3. Authorization Code ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
// ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ë¶„ì„í•´ì„œ codeë¥¼ êº¼ë‚´ëŠ” í•¨ìˆ˜

func extractAuthorizationCode(from url: URL) -> String? {
    let components = URLComponents(url: url, resolvingAgainstBaseURL: false)
    return components?.queryItems?.first(where: { $0.name == "code" })?.value
}

// 4. ì„œë²„ë¡œ code ë³´ë‚´ê¸°
// codeë¥¼ ì¶”ì¶œí•œ ë‹¤ìŒ, ê°„ë‹¨í•˜ê²Œ ì„œë²„ë¡œ POST ìš”ì²­

func sendAuthorizationCodeToBackend(code: String) {
    guard let url = URL(string: "https://your.backend.server/auth/naver") else { return }
    
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    
    let body: [String: Any] = ["authorization_code": code]
    
    request.httpBody = try? JSONSerialization.data(withJSONObject: body, options: [])
    
    URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            print("Error sending code to backend:", error)
            return
        }
        print("Successfully sent code to backend!")
    }.resume()
}
